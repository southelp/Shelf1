<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±… í‘œì§€ ì¸ì‹ ì•±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #8BC34A;
            --background-color: #f0f4f8;
            --card-background: #ffffff;
            --text-color: #333;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px var(--shadow-color);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: 700;
        }

        #cameraFeed {
            width: 100%;
            height: auto;
            max-height: 300px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            border: 2px solid #ddd;
            display: block;
        }

        #recognizeBtn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.1s ease;
            margin-top: 20px;
            width: 100%;
        }
        
        #recognizeBtn:hover {
            background-color: #0056b3;
        }

        #recognizeBtn:active {
            transform: scale(0.98);
        }

        .result-box {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 30px;
            text-align: left;
            border: 1px solid #eee;
        }

        .result-box h3 {
            margin-top: 0;
            color: #555;
        }

        .result-box p {
            margin: 8px 0;
            font-size: 15px;
        }
        
        .result-box strong {
            color: var(--primary-color);
        }
        
        .loading {
            margin-top: 20px;
            font-style: italic;
            color: #888;
        }

        /* ë©”ì‹œì§€ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .message-box {
            background-color: #ffcccc;
            color: #d9534f;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            text-align: center;
            font-weight: 700;
            border: 1px solid #d9534f;
            display: none;
        }

        .book-item {
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .book-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“š ì±… í‘œì§€ ì¸ì‹ê¸°</h1>
    <video id="cameraFeed" autoplay playsinline></video>
    <canvas id="photoCanvas" style="display:none;"></canvas>
    
    <button id="recognizeBtn">ì±… ì •ë³´ ì¸ì‹í•˜ê¸°</button>
    
    <p class="loading" id="loadingText" style="display: none;">
        ë¡œë”© ì¤‘...
    </p>

    <!-- ë©”ì‹œì§€ ë°•ìŠ¤ ì¶”ê°€ -->
    <div id="messageBox" class="message-box"></div>

    <div class="result-box" id="resultBox" style="display: none;">
        <h3 id="resultSummary">ì¸ì‹ ê²°ê³¼</h3>
        <div id="bookListContainer"></div>
    </div>
</div>

<script>
    // ì¹´ì¹´ì˜¤ REST API í‚¤ëŠ” ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ì§ì ‘ ì‚¬ìš©í•©ë‹ˆë‹¤.
    const KAKAO_REST_API_KEY = "046dac5667abf31ec98555fa419183f6";
    // Google API í‚¤ëŠ” ì´ ìº”ë²„ìŠ¤ í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
    const GOOGLE_API_KEY = "AIzaSyBv1vyf8zo8SFxhHrB_uIVyf5Ax-A5z38M";

    const cameraFeed = document.getElementById('cameraFeed');
    const photoCanvas = document.getElementById('photoCanvas');
    const recognizeBtn = document.getElementById('recognizeBtn');
    const loadingText = document.getElementById('loadingText');
    const resultBox = document.getElementById('resultBox');
    const bookListContainer = document.getElementById('bookListContainer');
    const resultSummary = document.getElementById('resultSummary');
    const messageBox = document.getElementById('messageBox');

    let uploadedImageBase64 = null;
    let timer;

    /**
     * ì‚¬ìš©ìì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜. alert()ë¥¼ ëŒ€ì²´í•©ë‹ˆë‹¤.
     * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€
     * @param {boolean} isError - ì˜¤ë¥˜ ë©”ì‹œì§€ ì—¬ë¶€
     */
    function showMessage(message, isError = false) {
        messageBox.textContent = message;
        messageBox.style.display = 'block';
        if (isError) {
            messageBox.style.backgroundColor = '#f8d7da';
            messageBox.style.color = '#721c24';
        } else {
            messageBox.style.backgroundColor = '#d4edda';
            messageBox.style.color = '#155724';
        }
    }

    // ì¹´ë©”ë¼ í”¼ë“œë¥¼ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment' // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„  ì‚¬ìš©
                }
            });
            cameraFeed.srcObject = stream;
        } catch (error) {
            console.error("ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜:", error);
            showMessage("ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.", true);
            recognizeBtn.disabled = true;
        }
    }

    // ì¸ì‹ ë²„íŠ¼ í´ë¦­ ì‹œ
    recognizeBtn.addEventListener('click', async function() {
        if (!cameraFeed.srcObject) {
            showMessage("ì¹´ë©”ë¼ í”¼ë“œê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", true);
            return;
        }

        loadingText.style.display = 'block';
        resultBox.style.display = 'none';
        messageBox.style.display = 'none';
        
        // 6ì´ˆ íƒ€ì„ì•„ì›ƒ íƒ€ì´ë¨¸ ì„¤ì •
        const timeoutPromise = new Promise((resolve, reject) => {
            timer = setTimeout(() => {
                reject(new Error("ë¡œë”© ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."));
            }, 6000); // 6ì´ˆ
        });
        
        try {
            // 1. ì¹´ë©”ë¼ ì˜ìƒì—ì„œ ì´ë¯¸ì§€ ìº¡ì²˜
            const videoWidth = cameraFeed.videoWidth;
            const videoHeight = cameraFeed.videoHeight;
            photoCanvas.width = videoWidth;
            photoCanvas.height = videoHeight;
            const ctx = photoCanvas.getContext('2d');
            ctx.drawImage(cameraFeed, 0, 0, videoWidth, videoHeight);
            
            // 2. ìº¡ì²˜ëœ ì´ë¯¸ì§€ë¥¼ 1024x1024 í”½ì…€ ì´í•˜ë¡œ ë¦¬ì‚¬ì´ì§•
            const resizedDataUrl = photoCanvas.toDataURL('image/jpeg');
            uploadedImageBase64 = await resizeImage(resizedDataUrl, 1024, 1024);

            // 3. Gemini APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì±… í‘œì§€ ì´ë¯¸ì§€ì—ì„œ ì •ë³´ ì¶”ë¡ 
            const geminiPromise = callGeminiAPI(uploadedImageBase64);
            const geminiResult = await Promise.race([geminiPromise, timeoutPromise]);
            clearTimeout(timer);
            
            console.log("Gemini API ê²°ê³¼:", geminiResult);

            if (!geminiResult || !Array.isArray(geminiResult.books) || geminiResult.books.length === 0) {
                 throw new Error("ì¸ì‹ ì‹¤íŒ¨: Gemini APIê°€ ì±… ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
            
            let successCount = 0;
            const totalBooks = geminiResult.books.length;
            bookListContainer.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

            for (const geminiBook of geminiResult.books) {
                let bookDetails = null;
                try {
                    if (geminiBook.language === "Korean") {
                        // 4. í•œêµ­ì–´ ì±…ì¼ ê²½ìš° Kakao API í˜¸ì¶œ
                        const kakaoPromise = callKakaoAPI(geminiBook.title);
                        const kakaoResult = await Promise.race([kakaoPromise, timeoutPromise]);
                        clearTimeout(timer);
                        
                        if (kakaoResult && kakaoResult.documents && kakaoResult.documents.length > 0) {
                            const item = kakaoResult.documents[0];
                            bookDetails = {
                                title: item.title,
                                author: item.authors ? item.authors.join(', ') : "ì •ë³´ ì—†ìŒ",
                                isbn: item.isbn || "ì •ë³´ ì—†ìŒ",
                                description: item.contents ? item.contents.substring(0, 200) + '...' : "ì •ë³´ ì—†ìŒ"
                            };
                            successCount++;
                        } else {
                            throw new Error("ì¹´ì¹´ì˜¤ APIì—ì„œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        }
                    } else {
                        // 5. ì™¸êµ­ì–´ ì±…ì¼ ê²½ìš° Google Books API í˜¸ì¶œ
                        const googlePromise = callBooksAPI(geminiBook.title);
                        const googleResult = await Promise.race([googlePromise, timeoutPromise]);
                        clearTimeout(timer);

                        if (googleResult && googleResult.items && googleResult.items.length > 0) {
                            const item = googleResult.items[0].volumeInfo;
                            bookDetails = {
                                title: item.title,
                                author: item.authors ? item.authors.join(', ') : "ì •ë³´ ì—†ìŒ",
                                isbn: item.industryIdentifiers ? item.industryIdentifiers[0].identifier : "ì •ë³´ ì—†ìŒ",
                                description: item.description ? item.description.substring(0, 200) + '...' : "ì •ë³´ ì—†ìŒ"
                            };
                            successCount++;
                        } else {
                            throw new Error("Google Books APIì—ì„œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        }
                    }
                } catch (apiError) {
                    console.error("ê°œë³„ API í˜¸ì¶œ ì˜¤ë¥˜:", apiError);
                    bookDetails = {
                        title: geminiBook.title,
                        author: geminiBook.author,
                        isbn: "ì¸ì‹ ì‹¤íŒ¨",
                        description: `API ê²€ìƒ‰ ì‹¤íŒ¨: ${apiError.message}`
                    };
                }
                
                // ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ
                const bookItemDiv = document.createElement('div');
                bookItemDiv.className = 'book-item';
                bookItemDiv.innerHTML = `
                    <p><strong>ì œëª©:</strong> <span>${bookDetails.title}</span></p>
                    <p><strong>ì €ì:</strong> <span>${bookDetails.author}</span></p>
                    <p><strong>ISBN:</strong> <span>${bookDetails.isbn}</span></p>
                    <p><strong>ì„¤ëª…:</strong> <span>${bookDetails.description}</span></p>
                `;
                bookListContainer.appendChild(bookItemDiv);
            }
            
            const failCount = totalBooks - successCount;
            resultSummary.textContent = `ì´ ${totalBooks}ê¶Œ ì¤‘ ${successCount}ê¶Œ ì¸ì‹ ì„±ê³µ. ${failCount}ê¶Œ ì¸ì‹ ì‹¤íŒ¨.`;
            
        } catch (error) {
            clearTimeout(timer);
            console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
            resultSummary.textContent = "ì¸ì‹ ì‹¤íŒ¨";
            bookListContainer.innerHTML = `<p>${error.message}</p>`;
        } finally {
            loadingText.style.display = 'none';
            resultBox.style.display = 'block';
        }
    });

    // ì´ë¯¸ì§€ íŒŒì¼ì„ 1024x1024 í”½ì…€ ì´í•˜ë¡œ ë¦¬ì‚¬ì´ì§•í•˜ê³  Base64ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
    function resizeImage(dataUrl, maxWidth, maxHeight) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = function() {
                let width = img.width;
                let height = img.height;
                
                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                const resizedDataUrl = canvas.toDataURL('image/jpeg');
                resolve(resizedDataUrl.split(',')[1]);
            };
            img.src = dataUrl;
        });
    }

    /**
     * Gemini APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì±… í‘œì§€ ì´ë¯¸ì§€ì—ì„œ ì •ë³´ë¥¼ ì¶”ë¡ í•©ë‹ˆë‹¤.
     * @param {string} base64Image - Base64 ì¸ì½”ë”©ëœ ì´ë¯¸ì§€ ë°ì´í„°
     */
    async function callGeminiAPI(base64Image) {
        const prompt = `ì´ ì´ë¯¸ì§€ëŠ” ì±… í‘œì§€ë¥¼ ì—¬ëŸ¬ ê°œ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤. ê° ì±…ì˜ ì œëª©, ì €ì, ê·¸ë¦¬ê³  ì–¸ì–´("Korean" ë˜ëŠ” "Foreign")ë¥¼ JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œí•´ì£¼ì„¸ìš”. ì—¬ëŸ¬ ê°œì˜ ì±…ì´ ìˆìœ¼ë©´ JSON ë°°ì—´ë¡œ ë°˜í™˜í•˜ê³ , ì±…ì´ í•œ ê°œë§Œ ìˆì–´ë„ JSON ë°°ì—´ë¡œ ë°˜í™˜í•˜ì„¸ìš”.
        ì¶œë ¥ í˜•ì‹: [{"title": "ì±… ì œëª©", "author": "ì €ì", "language": "Korean" ë˜ëŠ” "Foreign"}]`;
        
        const payload = {
            contents: [
                {
                    role: "user",
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64Image } }
                    ]
                }
            ],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "title": { "type": "STRING" },
                            "author": { "type": "STRING" },
                            "language": { "type": "STRING" }
                        }
                    }
                }
            }
        };
        
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        let retries = 0;
        const maxRetries = 3;
        while (retries < maxRetries) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const json = result.candidates[0].content.parts[0].text;
                        return { books: JSON.parse(json) };
                    } else {
                        throw new Error("Gemini APIê°€ ìœ íš¨í•œ ì‘ë‹µì„ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    }
                } else {
                    throw new Error(`Gemini API ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                retries++;
                if (retries >= maxRetries) {
                    throw error;
                }
                const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }

    /**
     * ì¹´ì¹´ì˜¤ ì±… ê²€ìƒ‰ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
     * @param {string} query - ì±… ì œëª©
     */
    async function callKakaoAPI(query) {
        const kakaoUrl = `https://dapi.kakao.com/v3/search/book?target=title&query=${encodeURIComponent(query)}`;
        
        let retries = 0;
        const maxRetries = 3;
        while (retries < maxRetries) {
            try {
                const response = await fetch(kakaoUrl, {
                    method: 'GET',
                    headers: { 'Authorization': `KakaoAK ${KAKAO_REST_API_KEY}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data;
                } else {
                    throw new Error(`Kakao API ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                retries++;
                if (retries >= maxRetries) {
                    throw error;
                }
                const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }

    /**
     * Google Books APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì±… ì •ë³´ ê²€ìƒ‰
     * @param {string} query - ì œëª©/ì €ì ê²€ìƒ‰ì–´
     */
    async function callBooksAPI(query) {
        const booksUrl = `https://www.googleapis.com/books/v1/volumes?key=${GOOGLE_API_KEY}&q=${encodeURIComponent(query)}`;
        
        let retries = 0;
        const maxRetries = 3;
        while (retries < maxRetries) {
            try {
                const response = await fetch(booksUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    return data;
                } else {
                    throw new Error(`Books API ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                retries++;
                if (retries >= maxRetries) {
                    throw error;
                }
                const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´ë©”ë¼ ì‹œì‘
    window.onload = startCamera;
</script>

</body>
</html>
